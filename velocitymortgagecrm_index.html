<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Velocity Mortgage CRM</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #e5e7eb;
      --shadow: 0 10px 25px rgba(0,0,0,0.08);
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --ink: #111827;
    }

    * { box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      display: flex;
      justify-content: center;
      padding: 40px;
      color: var(--text);
    }

    .wrap {
      width: 100%;
      max-width: 1200px;
    }

    .card {
      background: var(--card);
      padding: 24px;
      border-radius: 12px;
      width: 100%;
      box-shadow: var(--shadow);
    }

    h2 { margin: 0 0 20px 0; }

    label { font-weight: 600; margin-top: 12px; display: block; }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    button {
      margin-top: 20px;
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover { background: var(--primary-dark); }

    /* Top-right nav button */
    #navBtn {
      position: fixed;
      top: 16px;
      right: 16px;
      width: auto;
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 999px;
      background: var(--ink);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
      z-index: 50;
      display: none; /* shown only when logged in */
    }

    /* Secondary top-right button (logout) */
    #logoutBtn {
      position: fixed;
      top: 16px;
      right: 110px;
      width: auto;
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 999px;
      background: #ffffff;
      color: var(--ink);
      border: 1px solid var(--border);
      cursor: pointer;
      font-weight: 700;
      z-index: 50;
      display: none; /* shown only when logged in */
    }

    .success { margin-top: 15px; color: #16a34a; font-weight: 600; display: none; }
    .error { margin-top: 12px; color: #dc2626; font-weight: 600; display: none; }

    /* Clients page header */
    .clients-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
    }

    .clients-title {
      font-size: 22px;
      font-weight: 800;
      margin: 0;
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .control {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
    }

    .control input,
    .control select {
      border: none;
      outline: none;
      padding: 0;
      margin: 0;
      width: 260px;
      font-size: 14px;
    }

    .control select { width: 160px; }

    .icon {
      width: 16px;
      height: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-weight: 800;
    }

    /* Client cards grid (like your screenshot) */
    .clients-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(460px, 1fr));
      gap: 22px;
    }

    .client-card {
      background: #fff;
      border-radius: 18px;
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(229,231,235,0.6);
    }

    .client-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .client-id {
      display: flex;
      gap: 12px;
      align-items: center;
      min-width: 0;
    }

    .avatar {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: #111827;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      flex: 0 0 auto;
    }

    .name-email { min-width: 0; }

    .client-name {
      font-size: 18px;
      font-weight: 800;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 320px;
    }

    .client-email {
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 320px;
      margin-top: 3px;
    }

    .badge {
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid rgba(229,231,235,0.8);
      background: #eef2ff;
      color: #4338ca;
      white-space: nowrap;
    }

    .badge.completed {
      background: #ecfdf5;
      color: #047857;
    }

    .badge.intransit {
      background: #fff7ed;
      color: #9a3412;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 6px;
    }

    .metric-label { font-size: 12px; color: var(--muted); }
    .metric-value {
      font-size: 16px;
      font-weight: 800;
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .client-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .date-text { color: var(--muted); font-size: 13px; }

    .actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .icon-btn {
      width: auto;
      padding: 6px 10px;
      margin-top: 0;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--primary);
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
    }

    .icon-btn.danger { color: #dc2626; }

    .icon-btn.primary {
      background: #eef2ff;
      border-color: #e0e7ff;
      color: #4338ca;
    }

    .status-select {
      width: auto;
      padding: 6px 10px;
      margin-top: 0;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 12px;
      background: #fff;
      cursor: pointer;
    }

    .doc-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .doc-name {
      font-size: 12px;
      color: var(--muted);
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
      margin-top: 10px;
    }

    /* Login layout */
    .login-sub {
      color: var(--muted);
      margin-top: -10px;
      margin-bottom: 14px;
      font-size: 13px;
    }

    @media (max-width: 520px) {
      body { padding: 18px; }
      .clients-grid { grid-template-columns: 1fr; }
      .control input { width: 200px; }
      .metrics { grid-template-columns: 1fr; }
      .client-name, .client-email { max-width: 200px; }
      #logoutBtn { right: 96px; }
    }
  </style>
</head>
<body>

<button id="logoutBtn">Logout</button>
<button id="navBtn">Add Client</button>

<div class="wrap">
  <!-- LOGIN PAGE -->
  <div class="card" id="loginPage" style="max-width:520px; margin:0 auto;">
    <h2>Login</h2>
    <div class="login-sub">Enter your credentials to access the CRM.</div>

    <form id="loginForm">
      <label>Username</label>
      <input type="text" id="loginUsername" autocomplete="username" required />

      <label>Password</label>
      <input type="password" id="loginPassword" autocomplete="current-password" required />

      <button type="submit">Sign in</button>
    </form>

    <div class="error" id="loginError">Invalid username or password.</div>
    <div class="hint">Note: This is a simple local login (single-file app). For real security, we’ll connect a backend later.</div>
  </div>

  <!-- CLIENTS PAGE (default after login) -->
  <div class="card" id="clientsPage" style="display:none;">
    <div class="clients-top">
      <div>
        <h2 class="clients-title">All Applications</h2>
      </div>
      <div class="controls">
        <div class="control">
          <span class="icon">⌕</span>
          <input id="searchInput" placeholder="Search by name or email..." />
        </div>
        <div class="control">
          <span class="icon">⏷</span>
          <select id="statusFilter">
            <option value="">All Status</option>
            <option value="Pre-Approved">Pre-Approved</option>
            <option value="In-Transit">In-Transit</option>
            <option value="Completed">Completed</option>
          </select>
        </div>
      </div>
    </div>

    <div class="clients-grid" id="clientsGrid"></div>
    <div class="hint">Documents are tracked by filename (local only). To store actual files online later, we’ll connect a real database/storage.</div>
  </div>

  <!-- CLIENT INTAKE FORM -->
  <div class="card" id="formPage" style="display:none; max-width:640px; margin:0 auto;">
    <h2>Mortgage Client Information</h2>
    <form id="clientForm">
      <label>Full Name</label>
      <input type="text" id="fullName" required />

      <label>Email Address</label>
      <input type="email" id="email" required />

      <label>Phone Number</label>
      <input type="tel" id="phone" required />

      <label>Loan Amount</label>
      <input type="number" id="loanAmount" placeholder="e.g. 25000000" />

      <label>TRN</label>
      <input type="text" id="trn" />

      <label>Address</label>
      <input type="text" id="address" required />

      <label>Type of Loan</label>
      <select id="loanType" required>
        <option value="">Select</option>
        <option value="House">House</option>
        <option value="Land">Land</option>
        <option value="Construction">Construction</option>
        <option value="Other">Other</option>
      </select>

      <label>If Other, specify loan type</label>
      <input type="text" id="otherLoan" />

      <label>Referral Individual</label>
      <input type="text" id="referral" />

      <label>Bank for Mortgage</label>
      <input type="text" id="bank" required />

      <label>Pre-Approval Letter?</label>
      <select id="preApproval" required>
        <option value="">Select</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>

      <button type="submit" id="saveBtn">Save Client</button>
    </form>
    <div class="success" id="successMsg">Client saved successfully ✅</div>
  </div>
</div>

<script>
// --------------------------
// Simple local login settings
// --------------------------
// Change these to whatever you want.
const AUTH = {
  username: 'admin',
  password: 'password123'
};

const SESSION_KEY = 'vmcrm_session';

// Run after DOM exists
document.addEventListener('DOMContentLoaded', () => {
  // Pages
  const loginPage = document.getElementById('loginPage');
  const clientsPage = document.getElementById('clientsPage');
  const formPage = document.getElementById('formPage');

  // Top buttons
  const navBtn = document.getElementById('navBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  // Login
  const loginForm = document.getElementById('loginForm');
  const loginUsername = document.getElementById('loginUsername');
  const loginPassword = document.getElementById('loginPassword');
  const loginError = document.getElementById('loginError');

  // Client form
  const form = document.getElementById('clientForm');
  const successMsg = document.getElementById('successMsg');
  const saveBtn = document.getElementById('saveBtn');

  // Clients view
  const clientsGrid = document.getElementById('clientsGrid');
  const searchInput = document.getElementById('searchInput');
  const statusFilter = document.getElementById('statusFilter');

  let editIndex = null;

  // Helpers
  const safe = (v) => (v === undefined || v === null || String(v).trim() === '' ? '-' : String(v));
  const getInitial = (fullName) => {
    const s = safe(fullName);
    return s === '-' ? '?' : s[0].toUpperCase();
  };
  const formatDate = (iso) => {
    if (!iso) return '-';
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return '-';
    return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
  };

  function badgeClass(status) {
    if (status === 'Completed') return 'completed';
    if (status === 'In-Transit') return 'intransit';
    return '';
  }

  // Data
  function getClients() {
    return JSON.parse(localStorage.getItem('clients')) || [];
  }

  function setClients(clients) {
    localStorage.setItem('clients', JSON.stringify(clients));
  }

  // Session
  function isLoggedIn() {
    return localStorage.getItem(SESSION_KEY) === 'true';
  }

  function setLoggedIn(val) {
    localStorage.setItem(SESSION_KEY, val ? 'true' : 'false');
  }

  // Navigation
  function showPage(page) {
    // Hide all
    loginPage.style.display = 'none';
    clientsPage.style.display = 'none';
    formPage.style.display = 'none';

    // Show selected
    page.style.display = 'block';

    // Top buttons: only when logged in
    const logged = isLoggedIn();
    navBtn.style.display = logged ? 'block' : 'none';
    logoutBtn.style.display = logged ? 'block' : 'none';

    // Nav button label based on where we are
    if (!logged) {
      navBtn.textContent = 'Add Client';
      return;
    }

    if (page === clientsPage) {
      navBtn.textContent = 'Add Client';
    } else if (page === formPage) {
      navBtn.textContent = 'View Clients';
    }
  }

  // Filters
  function applyFilters(clients) {
    const q = (searchInput.value || '').toLowerCase().trim();
    const s = statusFilter.value || '';

    return clients.filter(c => {
      const name = (c.fullName || '').toLowerCase();
      const email = (c.email || '').toLowerCase();
      const matchesQuery = !q || name.includes(q) || email.includes(q);
      const matchesStatus = !s || (c.status || 'Pre-Approved') === s;
      return matchesQuery && matchesStatus;
    });
  }

  // Render cards
  function renderClients() {
    clientsGrid.innerHTML = '';

    const all = getClients();
    const clients = applyFilters(all);

    if (clients.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'hint';
      empty.textContent = 'No clients match your search/filter yet.';
      clientsGrid.appendChild(empty);
      return;
    }

    clients.forEach((client) => {
      const realIndex = all.indexOf(client);
      const status = client.status || 'Pre-Approved';

      const card = document.createElement('div');
      card.className = 'client-card';

      const fileInputId = `file_${realIndex}`;

      card.innerHTML = `
        <div class="client-header">
          <div class="client-id">
            <div class="avatar">${getInitial(client.fullName)}</div>
            <div class="name-email">
              <div class="client-name">${safe(client.fullName)}</div>
              <div class="client-email">${safe(client.email)}</div>
              <div class="client-email">${safe(client.phone)}</div>
            </div>
          </div>
          <span class="badge ${badgeClass(status)}">${safe(status)}</span>
        </div>

        <div class="metrics">
          <div>
            <div class="metric-label">Loan Amount</div>
            <div class="metric-value">${safe(client.loanAmount)}</div>
          </div>
          <div>
            <div class="metric-label">Bank</div>
            <div class="metric-value">${safe(client.bank)}</div>
          </div>
          <div>
            <div class="metric-label">Loan Type</div>
            <div class="metric-value">${safe(client.loanType)}${client.loanType === 'Other' ? `: ${safe(client.otherLoan)}` : ''}</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="client-footer">
          <div class="date-text">${formatDate(client.createdAt)}</div>

          <div class="actions">
            <select class="status-select" data-index="${realIndex}">
              <option value="Pre-Approved" ${status === 'Pre-Approved' ? 'selected' : ''}>Pre-Approved</option>
              <option value="In-Transit" ${status === 'In-Transit' ? 'selected' : ''}>In-Transit</option>
              <option value="Completed" ${status === 'Completed' ? 'selected' : ''}>Completed</option>
            </select>

            <div class="doc-wrap">
              <input id="${fileInputId}" type="file" style="display:none" />
              <button class="icon-btn primary" data-upload="${realIndex}">Upload</button>
              <span class="doc-name" title="${safe(client.document)}">${safe(client.document)}</span>
            </div>

            <button class="icon-btn" data-edit="${realIndex}">Edit</button>
            <button class="icon-btn danger" data-delete="${realIndex}">Delete</button>
          </div>
        </div>
      `;

      clientsGrid.appendChild(card);
    });

    // Wire card events
    clientsGrid.querySelectorAll('[data-edit]').forEach(btn => {
      btn.addEventListener('click', () => editClient(Number(btn.dataset.edit)));
    });

    clientsGrid.querySelectorAll('[data-delete]').forEach(btn => {
      btn.addEventListener('click', () => deleteClient(Number(btn.dataset.delete)));
    });

    clientsGrid.querySelectorAll('.status-select').forEach(sel => {
      sel.addEventListener('change', () => updateStatus(Number(sel.dataset.index), sel.value));
    });

    clientsGrid.querySelectorAll('[data-upload]').forEach(btn => {
      btn.addEventListener('click', () => {
        const i = Number(btn.dataset.upload);
        const input = document.getElementById(`file_${i}`);
        if (!input) return;
        input.click();
        input.onchange = () => uploadDoc(i, input.files && input.files[0]);
      });
    });
  }

  function updateStatus(index, status) {
    const clients = getClients();
    if (!clients[index]) return;
    clients[index].status = status;
    setClients(clients);
    renderClients();
  }

  function uploadDoc(index, file) {
    if (!file) return;
    const clients = getClients();
    if (!clients[index]) return;
    clients[index].document = file.name;
    setClients(clients);
    renderClients();
  }

  function deleteClient(index) {
    const clients = getClients();
    if (!clients[index]) return;
    const ok = confirm(`Delete ${clients[index].fullName || 'this client'}?`);
    if (!ok) return;
    clients.splice(index, 1);
    setClients(clients);

    if (editIndex === index) {
      editIndex = null;
      saveBtn.textContent = 'Save Client';
      form.reset();
    }

    renderClients();
  }

  function editClient(index) {
    const clients = getClients();
    const c = clients[index];
    if (!c) return;

    document.getElementById('fullName').value = c.fullName || '';
    document.getElementById('email').value = c.email || '';
    document.getElementById('phone').value = c.phone || '';
    document.getElementById('loanAmount').value = c.loanAmount || '';
    document.getElementById('trn').value = c.trn || '';
    document.getElementById('address').value = c.address || '';
    document.getElementById('loanType').value = c.loanType || '';
    document.getElementById('otherLoan').value = c.otherLoan || '';
    document.getElementById('referral').value = c.referral || '';
    document.getElementById('bank').value = c.bank || '';
    document.getElementById('preApproval').value = c.preApproval || '';

    editIndex = index;
    saveBtn.textContent = 'Update Client';

    showPage(formPage);
  }

  // Form submit
  form.addEventListener('submit', (e) => {
    e.preventDefault();

    const clients = getClients();
    const existing = editIndex !== null ? clients[editIndex] : null;

    const client = {
      fullName: document.getElementById('fullName').value,
      email: document.getElementById('email').value,
      phone: document.getElementById('phone').value,
      loanAmount: document.getElementById('loanAmount').value,
      trn: document.getElementById('trn').value,
      address: document.getElementById('address').value,
      loanType: document.getElementById('loanType').value,
      otherLoan: document.getElementById('otherLoan').value,
      referral: document.getElementById('referral').value,
      bank: document.getElementById('bank').value,
      preApproval: document.getElementById('preApproval').value,
      status: existing?.status || 'Pre-Approved',
      document: existing?.document || '-',
      createdAt: existing?.createdAt || new Date().toISOString()
    };

    if (editIndex !== null) {
      clients[editIndex] = client;
      editIndex = null;
      saveBtn.textContent = 'Save Client';
    } else {
      clients.push(client);
    }

    setClients(clients);

    form.reset();
    successMsg.style.display = 'block';
    setTimeout(() => (successMsg.style.display = 'none'), 2500);

    // After save, go back to All Applications
    renderClients();
    showPage(clientsPage);
  });

  // Login handler
  loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    loginError.style.display = 'none';

    const u = loginUsername.value.trim();
    const p = loginPassword.value;

    if (u === AUTH.username && p === AUTH.password) {
      setLoggedIn(true);
      loginForm.reset();
      // First page after login = All Applications
      renderClients();
      showPage(clientsPage);
    } else {
      loginError.style.display = 'block';
    }
  });

  // Nav button toggles between All Applications and Add Client
  navBtn.addEventListener('click', () => {
    if (!isLoggedIn()) return;
    const onClients = clientsPage.style.display !== 'none';
    if (onClients) {
      showPage(formPage);
    } else {
      renderClients();
      showPage(clientsPage);
    }
  });

  // Logout
  logoutBtn.addEventListener('click', () => {
    setLoggedIn(false);
    editIndex = null;
    saveBtn.textContent = 'Save Client';
    form.reset();
    loginError.style.display = 'none';
    showPage(loginPage);
  });

  searchInput.addEventListener('input', renderClients);
  statusFilter.addEventListener('change', renderClients);

  // Basic test cases (run in console) — helps catch regressions
  (function runTests() {
    console.assert(safe(undefined) === '-', 'safe(undefined) should be -');
    console.assert(safe('') === '-', 'safe("") should be -');
    console.assert(getInitial('Yahvari') === 'Y', 'initial should be first letter');
    console.assert(getInitial('') === '?', 'initial empty should be ?');
    console.assert(formatDate('not-a-date') === '-', 'formatDate invalid should be -');
  })();

  // Initial route
  if (isLoggedIn()) {
    renderClients();
    showPage(clientsPage); // First page after login
  } else {
    showPage(loginPage);
  }
});
</script>
</body>
</html>
